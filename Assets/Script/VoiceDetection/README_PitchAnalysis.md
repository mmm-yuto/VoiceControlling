# ピッチ分析アルゴリズム改善

## 問題点
- 音量に依存したピッチ検知
- ノイズに弱い
- 基本周波数の検出精度が低い

## 解決策

### 1. ImprovedPitchAnalyzer.cs
Unity内で実装された改良版ピッチ分析器

#### 主な改善点
- **音量正規化**: 音量に依存しないピッチ検知
- **バンドパスフィルタ**: 人間の声の周波数帯域のみを通過
- **オートコリレーション法**: 基本周波数の直接検出
- **ハーモニック検出**: 高調波を考慮した検出
- **フレーム履歴**: 複数フレームの結果を統合して安定化

#### 使用方法
1. `PitchAnalyzer.cs`を`ImprovedPitchAnalyzer.cs`に置き換え
2. インスペクターで設定を調整
3. テストモードで動作確認

### 2. ExternalPitchAnalyzer.cs
外部ライブラリを使用した高精度版

#### 外部ライブラリの利点
- **高精度なFFT**: 専門的な信号処理ライブラリ
- **最適化されたアルゴリズム**: C/C++で実装された高速処理
- **豊富な機能**: ノイズ除去、エコーキャンセレーションなど

#### 推奨外部ライブラリ

##### 1. Essentia (C++)
```cpp
// 高品質な音声分析ライブラリ
// 音楽情報検索、音声認識に特化
// オープンソース
```

##### 2. aubio (C)
```cpp
// リアルタイム音声分析
// ピッチ検出、ビート検出、オセット検出
// 軽量で高速
```

##### 3. YIN Algorithm (C++)
```cpp
// ピッチ検出専用アルゴリズム
// 高精度でノイズに強い
// 実装が比較的簡単
```

## 実装手順

### Step 1: Unity内実装
1. `ImprovedPitchAnalyzer.cs`をプロジェクトに追加
2. 既存の`PitchAnalyzer`を置き換え
3. 設定値を調整してテスト

### Step 2: 外部ライブラリ統合（オプション）
1. 外部ライブラリをダウンロード・ビルド
2. DLLファイルをUnityプロジェクトに配置
3. `ExternalPitchAnalyzer.cs`を使用

## 設定パラメータ

### 基本設定
```csharp
public float minFrequency = 80f;        // 最低周波数
public float maxFrequency = 1000f;      // 最高周波数
public float volumeThreshold = 0.01f;   // 音量閾値
public float smoothingFactor = 0.1f;    // スムージング係数
```

### 高度な設定
```csharp
public float autocorrelationThreshold = 0.3f;  // オートコリレーション閾値
public int frameHistorySize = 5;               // フレーム履歴サイズ
public bool useAdvancedFiltering = true;       // 高度なフィルタリング
```

## 期待される改善効果

### 1. 音量依存の解消
- 小さい声でも正確なピッチ検知
- 大きい声でも適切なピッチ検知

### 2. ノイズ耐性の向上
- 環境音の影響を軽減
- より安定した検知

### 3. 精度の向上
- 基本周波数の正確な検出
- 個人差への対応

## テスト方法

### 1. 音量テスト
- 同じ音程で音量を変えてテスト
- ピッチ値が一定であることを確認

### 2. 音程テスト
- 低い音程から高い音程までテスト
- 線形な変化を確認

### 3. ノイズテスト
- 環境音がある状態でテスト
- 安定した検知を確認

## トラブルシューティング

### よくある問題
1. **ピッチが検知されない**
   - 音量閾値を下げる
   - マイクの感度を確認

2. **ピッチが不安定**
   - スムージング係数を調整
   - フレーム履歴サイズを増やす

3. **外部ライブラリが動作しない**
   - DLLファイルの配置を確認
   - プラットフォーム対応を確認

## 次のステップ
1. `ImprovedPitchAnalyzer`でテスト
2. 必要に応じて外部ライブラリを検討
3. 設定値を最適化
4. 実際のゲームで検証
